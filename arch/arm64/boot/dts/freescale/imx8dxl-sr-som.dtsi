// SPDX-License-Identifier: GPL-2.0+
/*
 * Copyright 2022 Josua Mayer <josua@solid-run.com>
 */

/ {
	chosen {
		stdout-path = &lpuart0;
	};

	/* 1GB LPDDR4 */
	/* TODO: is this required? */
	memory@80000000 {
		device_type = "memory";
		reg = <0x00000000 0x80000000 0 0x40000000>;
	};

	reserved-memory {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		/*
		 * 0x8800_0000 ~ 0x8FFF_FFFF is reserved for M4
		 * Shouldn't be used at A core and Linux side.
		 *
		 */
		m4_reserved: m4@0x88000000 {
			no-map;
			reg = <0 0x88000000 0 0x8000000>;
		};

		/* TODO: why? is this required? */
		rpmsg_reserved: rpmsg@0x90200000 {
			no-map;
			reg = <0 0x90200000 0 0x200000>;
		};

		/* 64MB CMA region */
		/* TODO: is this required? What size? */
		linux,cma {
			compatible = "shared-dma-pool";
			reusable;
			size = <0 0x04000000>;
			alloc-ranges = <0 0x98000000 0 0x04000000>;
			linux,cma-default;
		};

		/* TODO: EVK reserves memory for vdevs here ... */
	};

	v2x_reg_1v2: regulator-v2x-1v2 {
		compatible = "regulator-fixed";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_v2x_reg_1v2>;
		regulator-name = "v2x-1v2";
		regulator-min-microvolt = <1200000>;
		regulator-max-microvolt = <1200000>;
		gpio = <&lsio_gpio1 13 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		regulator-always-on;
	};

	v2x_reg_1v6: regulator-v2x-1v6 {
		compatible = "regulator-fixed";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_v2x_reg_1v6>;
		regulator-name = "v2x-1v6";
		regulator-min-microvolt = <1600000>;
		regulator-max-microvolt = <1600000>;
		gpio = <&lsio_gpio1 14 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		regulator-always-on;
	};

	v2x_secure_reg_1v8: regulator-v2x-secure-1v8 {
		compatible = "regulator-fixed";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_v2x_secure_reg_1v8>;
		regulator-name = "v2x-secure-1v8";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;
		gpio = <&lsio_gpio3 18 GPIO_ACTIVE_HIGH>;
		enable-active-high;
		regulator-always-on;
	};
};

&edma2 {
	status = "okay";
};

/* exposed on J14: SDA(51), SCL(53) */
&i2c2 {
	#address-cells = <1>;
	#size-cells = <0>;
	clock-frequency = <100000>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2c2>;
	status = "okay";

	/* MIA-M10Q (400kHz max.)*/
	/*gnss_ddc: mia-m10q@42 {
		reg = <0x42>;
		compatible = "u-blox,mia-m10";
	};*/
};

&iomuxc {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_hog>;

		/* TODO: check */
		pinctrl_hog: hoggrp {
			fsl,pins = <
				IMX8DXL_COMP_CTL_GPIO_1V8_3V3_GPIORHB_PAD	0x000514a0
				IMX8DXL_COMP_CTL_GPIO_1V8_3V3_GPIORHK_PAD	0x000014a0

				/* 32kHz for wifi */
				IMX8DXL_MCLK_OUT0_ADMA_ACM_MCLK_OUT0	0x0600004c
			>;
		};

		pinctrl_i2c2: i2c2grp {
			fsl,pins = <
				/* io with pull-up and strong drive */
				IMX8DXL_SPI1_SCK_ADMA_I2C2_SDA		0x06000020
				IMX8DXL_SPI1_SDO_ADMA_I2C2_SCL		0x06000020
			>;
		};

		pinctrl_lpspi2: lpspi2grp {
			fsl,pins = <
				IMX8DXL_USDHC1_RESET_B_ADMA_SPI2_SCK	0x600004c
				IMX8DXL_USDHC1_VSELECT_ADMA_SPI2_SDO	0x600004c
				IMX8DXL_USDHC1_WP_ADMA_SPI2_SDI			0x600004c
				IMX8DXL_USDHC1_CD_B_ADMA_SPI2_CS0		0x600004c
			>;
		};

		pinctrl_lpuart0: lpuart0grp {
			fsl,pins = <
				IMX8DXL_UART0_RX_ADMA_UART0_RX		0x06000020
				IMX8DXL_UART0_TX_ADMA_UART0_TX		0x06000020
			>;
		};

		pinctrl_lpuart2: lpuart2grp {
			fsl,pins = <
				IMX8DXL_UART2_TX_ADMA_UART2_TX		0x06000020
				IMX8DXL_UART2_RX_ADMA_UART2_RX		0x06000020
			>;
		};

		pinctrl_lpuart2_gps: lpuart2gpsgrp {
			fsl,pins = <
				/* gps reset: input with pull-up */
				/* TODO: change board layout for output-capable gpio */
				IMX8DXL_SNVS_TAMPER_OUT4_LSIO_GPIO2_IO08_IN		0x0000021
				/* IMX8DXL_SNVS_TAMPER_OUT4_LSIO_GPIO6_IO22_IN */

				/* gps interrupt: io without pull-up */
				IMX8DXL_SNVS_TAMPER_IN0_LSIO_GPIO2_IO09_IN		0x0000061
				/* IMX8DXL_SNVS_TAMPER_IN0_LSIO_GPIO6_IO23_IN */

				/* gps timepulse: input without pull-up */
				IMX8DXL_SNVS_TAMPER_OUT2_LSIO_GPIO2_IO06_IN		0x0000061
			>;
		};

		pinctrl_usdhc1: usdhc1grp {
			fsl,pins = <
				IMX8DXL_EMMC0_CLK_CONN_EMMC0_CLK			0x06000041
				IMX8DXL_EMMC0_CMD_CONN_EMMC0_CMD			0x00000021
				IMX8DXL_EMMC0_DATA0_CONN_EMMC0_DATA0		0x00000021
				IMX8DXL_EMMC0_DATA1_CONN_EMMC0_DATA1		0x00000021
				IMX8DXL_EMMC0_DATA2_CONN_EMMC0_DATA2		0x00000021
				IMX8DXL_EMMC0_DATA3_CONN_EMMC0_DATA3		0x00000021
				IMX8DXL_EMMC0_DATA4_CONN_EMMC0_DATA4		0x00000021
				IMX8DXL_EMMC0_DATA5_CONN_EMMC0_DATA5		0x00000021
				IMX8DXL_EMMC0_DATA6_CONN_EMMC0_DATA6		0x00000021
				IMX8DXL_EMMC0_DATA7_CONN_EMMC0_DATA7		0x00000021
				IMX8DXL_EMMC0_STROBE_CONN_EMMC0_STROBE		0x00000041
				IMX8DXL_EMMC0_RESET_B_CONN_EMMC0_RESET_B	0x00000021
			>;
		};

		pinctrl_usdhc1_100mhz: usdhc1grp100mhz {
			fsl,pins = <
				IMX8DXL_EMMC0_CLK_CONN_EMMC0_CLK			0x06000041
				IMX8DXL_EMMC0_CMD_CONN_EMMC0_CMD			0x00000021
				IMX8DXL_EMMC0_DATA0_CONN_EMMC0_DATA0		0x00000021
				IMX8DXL_EMMC0_DATA1_CONN_EMMC0_DATA1		0x00000021
				IMX8DXL_EMMC0_DATA2_CONN_EMMC0_DATA2		0x00000021
				IMX8DXL_EMMC0_DATA3_CONN_EMMC0_DATA3		0x00000021
				IMX8DXL_EMMC0_DATA4_CONN_EMMC0_DATA4		0x00000021
				IMX8DXL_EMMC0_DATA5_CONN_EMMC0_DATA5		0x00000021
				IMX8DXL_EMMC0_DATA6_CONN_EMMC0_DATA6		0x00000021
				IMX8DXL_EMMC0_DATA7_CONN_EMMC0_DATA7		0x00000021
				IMX8DXL_EMMC0_STROBE_CONN_EMMC0_STROBE		0x00000041
				IMX8DXL_EMMC0_RESET_B_CONN_EMMC0_RESET_B	0x00000021
			>;
		};

		pinctrl_usdhc1_200mhz: usdhc1grp200mhz {
			fsl,pins = <
				IMX8DXL_EMMC0_CLK_CONN_EMMC0_CLK			0x06000041
				IMX8DXL_EMMC0_CMD_CONN_EMMC0_CMD			0x00000021
				IMX8DXL_EMMC0_DATA0_CONN_EMMC0_DATA0		0x00000021
				IMX8DXL_EMMC0_DATA1_CONN_EMMC0_DATA1		0x00000021
				IMX8DXL_EMMC0_DATA2_CONN_EMMC0_DATA2		0x00000021
				IMX8DXL_EMMC0_DATA3_CONN_EMMC0_DATA3		0x00000021
				IMX8DXL_EMMC0_DATA4_CONN_EMMC0_DATA4		0x00000021
				IMX8DXL_EMMC0_DATA5_CONN_EMMC0_DATA5		0x00000021
				IMX8DXL_EMMC0_DATA6_CONN_EMMC0_DATA6		0x00000021
				IMX8DXL_EMMC0_DATA7_CONN_EMMC0_DATA7		0x00000021
				IMX8DXL_EMMC0_STROBE_CONN_EMMC0_STROBE		0x00000041
				IMX8DXL_EMMC0_RESET_B_CONN_EMMC0_RESET_B	0x00000021
			>;
		};

		pinctrl_usdhc2: usdhc2grp {
			fsl,pins = <
				IMX8DXL_ENET0_RGMII_RXC_CONN_USDHC1_CLK			0x06000040 /* roadlink evk sources set strength to high */
				IMX8DXL_ENET0_RGMII_RX_CTL_CONN_USDHC1_CMD		0x00000021
				IMX8DXL_ENET0_RGMII_RXD0_CONN_USDHC1_DATA0		0x00000021
				IMX8DXL_ENET0_RGMII_RXD1_CONN_USDHC1_DATA1		0x00000021
				IMX8DXL_ENET0_RGMII_RXD2_CONN_USDHC1_DATA2		0x00000021
				IMX8DXL_ENET0_RGMII_RXD3_CONN_USDHC1_DATA3		0x00000021
			>;
		};

		/* do we need all 3 modes? */
		pinctrl_usdhc2_100mhz: usdhc2grp100mhz {
			fsl,pins = <
				IMX8DXL_ENET0_RGMII_RXC_CONN_USDHC1_CLK			0x06000040 /* roadlink evk sources set strength to high */
				IMX8DXL_ENET0_RGMII_RX_CTL_CONN_USDHC1_CMD		0x00000021
				IMX8DXL_ENET0_RGMII_RXD0_CONN_USDHC1_DATA0		0x00000021
				IMX8DXL_ENET0_RGMII_RXD1_CONN_USDHC1_DATA1		0x00000021
				IMX8DXL_ENET0_RGMII_RXD2_CONN_USDHC1_DATA2		0x00000021
				IMX8DXL_ENET0_RGMII_RXD3_CONN_USDHC1_DATA3		0x00000021
			>;
		};

		/* do we need all 3 modes? */
		pinctrl_usdhc2_200mhz: usdhc2grp200mhz {
			fsl,pins = <
				IMX8DXL_ENET0_RGMII_RXC_CONN_USDHC1_CLK			0x06000040 /* roadlink evk sources set strength to high */
				IMX8DXL_ENET0_RGMII_RX_CTL_CONN_USDHC1_CMD		0x00000021
				IMX8DXL_ENET0_RGMII_RXD0_CONN_USDHC1_DATA0		0x00000021
				IMX8DXL_ENET0_RGMII_RXD1_CONN_USDHC1_DATA1		0x00000021
				IMX8DXL_ENET0_RGMII_RXD2_CONN_USDHC1_DATA2		0x00000021
				IMX8DXL_ENET0_RGMII_RXD3_CONN_USDHC1_DATA3		0x00000021
			>;
		};

		pinctrl_v2x: v2xgrp {
			fsl,pins = <
				/* v2x reset: io without pull */
				IMX8DXL_ADC_IN0_LSIO_GPIO1_IO10		0x0000060

				/*
				 * v2x boot0: io without pull
				 * After reset, this pin selects modem boot media:
				 * - 0: flash spi
				 * - 1: slave sdio
				 * Once the firmware boots however, the modem controls
				 * this pin for flow-control to signal readiness.
				 */
				IMX8DXL_ADC_IN1_LSIO_GPIO1_IO09		0x0000060 /* io without pull */
				/* TODO: check whether this pin should have SoC pull-down, or external resistor, or neither */
			>;
		};

		pinctrl_v2x_reg_1v2: v2xreg1v2grp {
			fsl,pins = <
				/* io without pull-up */
				/* has etxernal pull-down */
				IMX8DXL_ADC_IN5_LSIO_GPIO1_IO13		0x0000061
			>;
		};

		pinctrl_v2x_reg_1v6: v2xreg1v6grp {
			fsl,pins = <
				/* io without pull-up */
				/* has etxernal pull-down */
				IMX8DXL_ADC_IN4_LSIO_GPIO1_IO14		0x0000061
			>;
		};

		pinctrl_v2x_secure: v2xsecuregrp {
			fsl,pins = <
				/* v2x-secure-element reset: io with pull-up */
				IMX8DXL_QSPI0B_DATA1_LSIO_GPIO3_IO19	0x0000021

				/* v2x-secure-element gpio0: io without pull-up */
				IMX8DXL_QSPI0B_DATA2_LSIO_GPIO3_IO20	0x0000061

				/* v2x-secure-element gpio1: io without pull-up */
				IMX8DXL_QSPI0B_DATA3_LSIO_GPIO3_IO21	0x0000061
			>;
		};

		pinctrl_v2x_secure_reg_1v8: v2xsecurereg1v8grp {
			fsl,pins = <
				/* v2x-secure-element power switch: io without pull-up */
				IMX8DXL_QSPI0B_DATA0_LSIO_GPIO3_IO18	0x0000061
			>;
		};

		pinctrl_wifi: wifigrp {
			fsl,pins = <
				/* wl_reg_on: io without pull-up */
				/* IMX8DXL_SPI3_CS1 not a GPIO :( */
				IMX8DXL_SPI3_CS1_ADMA_SPI3_CS1		0x0000061
				/* measure if this is high */
			>;
		};

		pinctrl_bluetooth: bluetoothgrp {
			fsl,pins = <
				/* bt_reg_on: io without pull-up TODO: pull-up */
				IMX8DXL_SPI3_SCK_LSIO_GPIO0_IO13	0x0000061
			>;
		};
};

&lpspi2 {
	fsl,spi-num-chipselects = <1>;
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpspi2>;
	//pinctrl-assert-gpios = <&pca6416_1 7 GPIO_ACTIVE_HIGH>; // <-- what be dis?>
	status = "okay";

	/* SXF1800 (SoM) */
	v2x_secure_element: sxf1800@0 {
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_v2x_secure>;
		reg = <0>;
		compatible = "rohm,dh2228fv";
		spi-max-frequency = <30000000>;
		power-supply = <&v2x_secure_reg_1v8>; // should be always on maybe?
	};
};

/* console */
&lpuart0 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart0>;
	status = "okay";
};

/* gps */
&lpuart2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_lpuart2>;
	status = "okay";

	/* MIA-M10Q */
	gnss {
		compatible = "u-blox,mia-m10", "u-blox,neo-m8";
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_lpuart2_gps>;
		// enable-gpios = <&lsio_gpio2 8 GPIO_ACTIVE_HIGH>;
		timepulse-gpios = <&lsio_gpio2 6 GPIO_ACTIVE_HIGH>;
		current-speed = <38400>;
		u-blox,extint-gpios = <&lsio_gpio2 9 GPIO_ACTIVE_HIGH>;
	};
};

/* OTG port for boot */
&usbotg1 {
	srp-disable;
	hnp-disable;
	adp-disable;
	power-active-high;
	disable-over-current;
	dr_mode = "peripheral";
	status = "okay";
};

&usbphy1 {
	status = "okay";
};

&usdhc1 {
		pinctrl-names = "default", "state_100mhz", "state_200mhz";
		pinctrl-0 = <&pinctrl_usdhc1>;
		pinctrl-1 = <&pinctrl_usdhc1_100mhz>;
		pinctrl-2 = <&pinctrl_usdhc1_200mhz>;
		bus-width = <8>;
		no-sd;
		no-sdio;
		non-removable;
		status = "okay";
};

&usdhc2 {
		pinctrl-names = "default", "state_100mhz", "state_200mhz";
		pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_v2x>;
		pinctrl-1 = <&pinctrl_usdhc2_100mhz>, <&pinctrl_v2x>;
		pinctrl-2 = <&pinctrl_usdhc2_200mhz>, <&pinctrl_v2x>;
		bus-width = <4>;
		no-sd;
		non-removable;
		status = "okay";
		max-frequency = <40000000>;
		fsl,delay-line = <12>;
		keep-power-in-suspend;
		enable-sdio-wakeup;
		//mmc-pwrseq = <&v2x_pwrseq>;
		//vmmc-supply = <&v2x_reg_1v2>;
		//vmmc_aux-supply = <&v2x_reg_1v6>;
};
